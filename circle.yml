# https://discuss.circleci.com/t/add-ability-to-cache-apt-get-programs/598/4

dependencies:
    cache_directories:
       - "~/.opam"
       - "~/aptcache"
    override:
# https://discuss.circleci.com/t/caching-apt-get-packages/9076 to cache apt packages
        - sudo add-apt-repository -y ppa:avsm/ppa
        - sudo mkdir -p ~/aptcache/partial
        - sudo touch ~/aptcache/lock
        - sudo chmod 640 ~/aptcache/lock
        - sudo apt-get update -o dir::cache::archives="/home/ubuntu/aptcache" -y
        - sudo apt-get install -o dir::cache::archives="/home/ubuntu/aptcache" -y ocaml ocaml-native-compilers opam
        - opam init --auto-setup --dot-profile=~/.bashrc # Modify dotfiles
        - opam switch 4.02.3
        - eval `opam config env`
        - opam update
        - opam pin add -y reason .

compile:
    override:
        - make build

test:
    override:
        - make test
        - git diff --exit-code
